$().ready(function(){var l="";(function(q){q.getUrlParam=function(s){var t=new RegExp("(^|&)"+s+"=([^&]*)(&|$)");var u=window.location.search.substr(1).match(t);if(u!=null){return decodeURIComponent(u[2])}return null}})(jQuery);function m(){$("#recommend").val($.getUrlParam("recommend"))}function g(){var q=$.getUrlParam("productId");var r=$.getUrlParam("shopId");if(q){window.location.href="gncapp://product?productId="+q}else{if(r){window.location.href="gncapp://shop?shopId="+r}}}g();m();j();$.validator.setDefaults({submitHandler:function(){function w(){$.mobile.loading("show",{text:"正在注册中...",textVisible:true,theme:"a",textonly:false,html:""})}function q(){$.mobile.loading("hide")}w();var x=$("#cellphone").val();var s=$("#code").val();var v=$("#password").val();var r=$("#RPassword").val();var t=$("#recommend").val();var u=$("#citySel").val();var y=$("#icode").val();if(!u){return}$.ajax({type:"post",url:l+"/api/user/register",data:{mobile:x,code:s,password:v,repeatPassword:r,recommendCode:t,province:h[c[0]].text,city:b[c[1]].text,area:k[c[2]].text,registerSource:"h5",captcha:y},dataType:"json",success:function(z){if(z.code.toString()=="200"){location.href="download.html"}else{q();$("#error_info").html(z.msg);$("#user_reg_err").popup("open")}},error:function(z){q()}})}});$("#user_reg").validate({rules:{cellphone:{required:true,mobile:true},password:{required:true,minlength:8,maxlength:32,checkPwd:true},RPassword:{required:true,minlength:8,maxlength:32,checkPwd:true,equalTo:"#password"},code:{required:true,checkCode:true},icode:{required:true,minlength:4,maxlength:4},citySel:{required:true},agreement:"required"},messages:{cellphone:{required:"请输入手机号",byteRangeLength:"请输入正确的手机号"},password:{required:"请输入密码",minlength:"密码长度不能小于8个字母"},RPassword:{required:"请输入密码",minlength:"密码长度不能小于8个字母",equalTo:"两次密码输入不一致"},code:{required:"请输入短信验证码",},icode:{required:"请输入图形验证码",},citySel:{required:"请选择地址",},agreement:"请先同意用户协议"},errorPlacement:function(q,r){q.insertAfter(r.parent())}});$.validator.addMethod("mobile",function(t,r){var s=t.length;var q=/^1[3-9][0-9]{9}/;return this.optional(r)||(s==11&&q.test(t))},"请输入正确的手机号");$.validator.addMethod("checkCode",function(t,q){var s=t.length;var r=/^[0-9]{6}$/;return this.optional(q)||(s==6&&r.test(t))},"请输入正确的短信验证码");$.validator.addMethod("checkPwd",function(r,q){var s=/^[a-zA-z0-9]{8,32}$/;return this.optional(q)||(s.test(r))},"*密码是由长度为8-32位的字母和数字组成");function j(){$.ajax({type:"get",url:l+"/api/version/url",dataType:"json",success:function(q){if(q.code.toString()=="200"){$("#downIos").attr("href",q.data.iosUrl);$("#downAndroid").attr("href",q.data.androidUrl)}},error:function(q){console.log(q)}})}var f=false;$("#btnCode").click(function(){var q=$("#cellphone").val();var r=$("#icode").val();if(!r){$("#error_info").html("请先输入图形二维码");$("#user_reg_err").popup("open");return}if(!f&&q.match(/^1[3-9][0-9]{9}/)&&r){f=true;$.ajax({type:"post",url:l+"/api/sms/code/register",data:{mobile:q,captcha:r},dataType:"json",success:function(s){if(s.code.toString()=="200"){var t=60;var u=setInterval(function(){t=t-1;$("#btnCode").text("已发送"+t+"s");if(t==0){f=false;$("#btnCode").text("重新获取");clearInterval(u)}},1000)}else{f=false;$("#error_info").html(s.msg);$("#user_reg_err").popup("open")}},error:function(s){f=false}})}});$("#icodeImage").click(function(){$("#icodeImage").attr("src",l+"/api/captcha.jpg?"+Math.random())});var a=$("#citySel");var h=[];var b=[];var k=[];var c=[0,0,0];var o=[0,0,0];var e=[];function d(){$.ajax({type:"get",url:l+"/api/area/list/all",dataType:"json",success:function(q){if(q.code.toString()=="200"){q.data.areaList.forEach(function(s,r){var t={id:s.area.id,name:s.area.name,sub:[],};s.areaChild.forEach(function(u){var v={id:u.area.id,name:u.area.name,parent:t.id,sub:[]};u.areaChild.forEach(function(w){v.sub.push({name:w.area.name,parent:v.id})});t.sub.push(v)});e.push(t)});n(e,h);if(e[c[0]].hasOwnProperty("sub")){n(e[c[0]].sub,b)}else{b=[{text:"",value:0}]}if(e[c[0]].sub[c[1]].hasOwnProperty("sub")){n(e[c[0]].sub[c[1]].sub,k)}else{k=[{text:"",value:0}]}p()}},error:function(q){f=false}})}d();function n(r,q){r.forEach(function(v,u,s){var t=new Object();t.text=v.name;t.id=v.id;t.parent=v.parent;t.value=u;q.push(t)})}var i;function p(){i=new Picker({data:[h,b,k],selectedIndex:c,title:"地址选择"});i.on("picker.select",function(w,s){var y=h[s[0]];var u=b[s[1]];var z=k[s[2]];if(u.parent==y.id&&z.parent==u.id){var x=h[s[0]].text;var v=b[s[1]].text;var t=k[s[2]].text;$("#citySel").val(x+v+t)}else{if(u.parent==y.id){r(s[1])}else{q(s[0])}$("#citySel").val("")}});function q(t){b=[];k=[];o[0]=t;var s=e[t];if(s.hasOwnProperty("sub")){n(s.sub,b);var u=e[t].sub[0];if(u.hasOwnProperty("sub")){n(u.sub,k)}else{k=[{text:"",value:0}];o[2]=0}}else{b=[{text:"",value:0}];k=[{text:"",value:0}];o[1]=0;o[2]=0}i.refillColumn(1,b);i.refillColumn(2,k);i.scrollColumn(1,0);i.scrollColumn(2,0)}function r(s){k=[];o[1]=s;var t=o[0];if(e[t].sub[s].hasOwnProperty("sub")){var u=e[t].sub[s];n(u.sub,k);i.refillColumn(2,k);i.scrollColumn(2,0)}else{k=[{text:"",value:0}];o[2]=0;i.refillColumn(2,k);i.scrollColumn(2,0)}}i.on("picker.change",function(t,s){if(t===0){q(s)}else{if(t===1){r(s)}}})}$("#address").click(function(){$("#citySel").blur();if(i){i.show()}})});